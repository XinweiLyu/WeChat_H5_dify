import{d as e,s as o,n as t,a as n,o as s,c as i,w as l,_ as a,b as c,e as r,t as d,f as u,g,h,r as f,F as p,i as w,j as m}from"./index-BpLMNI0G.js";import{_}from"./config.CVVdX77V.js";import{g as v,a as x}from"./patient.Cw-6jL3V.js";import{_ as y}from"./_plugin-vue_export-helper.BCo6x5W8.js";const S={appId:"wx001a24bd7764b30a",scope:"snsapi_base",state:"STATE"},k={getAccessToken:"/user/wechat-login",getUserInfo:"/api/wechat/getUserInfo"};function I(){const e=window.location.search;console.log(e,"url");const o=new URLSearchParams(e);return{code:o.get("code"),state:o.get("state")}}function T(){const e=localStorage.getItem("wechat_user_info");return e?JSON.parse(e):null}function b(){return e=this,o=null,t=function*(){console.log(I(),"getUrlParams()");const{code:e}=I(),o=T();if(o)return console.log("发现已存储的用户信息，直接返回"),o;if(!e){console.log("没有code参数，准备跳转到微信授权页"),encodeURIComponent(function(){let e=window.location.href;return-1!==e.indexOf("#")&&(e=e.split("#")[0]),-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),e}());const e="https://open.weixin.qq.com/connect/oauth2/authorize?appid=".concat(S.appId,"&redirect_uri=https://zchat.i-llusion.cn&response_type=code&scope=").concat(S.scope);return console.log(window.location.href,"window.location.href"),console.log("生成的微信授权链接:",e),yield new Promise(e=>setTimeout(e,100)),window.location.href=e,null}console.log("检测到code参数，开始处理微信授权");try{const o=yield v(k.getAccessToken,{code:e});return console.log(o,"tokenResponse"),localStorage.setItem("token",o.data.access_token),t=o,localStorage.setItem("wechat_user_info",JSON.stringify(t)),console.log("微信授权成功，用户信息已保存"),o}catch(n){throw console.error("微信授权失败:",n),localStorage.removeItem("wechat_user_info"),n}var t},new Promise((n,s)=>{var i=e=>{try{a(t.next(e))}catch(o){s(o)}},l=e=>{try{a(t.throw(e))}catch(o){s(o)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,l);a((t=t.apply(e,o)).next())});var e,o,t}const L=y(e({data:()=>({userInfo:null,loading:!0,loadingText:"正在加载...",loadingSubtext:"",reportList:[],isNavigating:!1}),onLoad(){this.loading=!0,this.isNavigating=!1;const e=I().code;console.log("页面加载，URL中的code:",e),this.$nextTick(()=>{e?(console.log("检测到微信授权回调，开始处理授权"),this.initializeAuth()):(console.log("首次访问，准备跳转到微信授权页"),this.prepareWechatAuth())})},onShow(){this.loading&&console.log("页面显示时仍在加载中")},methods:{getUserListFn(){return _(this,void 0,void 0,(function*(){try{yield x()}catch(e){console.error("获取用户列表失败:",e),e.response&&401===e.response.status?(console.log("用户未授权，准备重新授权"),this.userInfo=null,this.loading=!1,o(new UTSJSONObject({title:"需要重新授权",content:"您的登录信息已过期，需要重新授权才能查看历史记录",confirmText:"重新授权",cancelText:"稍后再说",success:e=>{e.confirm?this.prepareWechatAuth():n({title:"您可以稍后点击按钮重新授权",icon:"none",duration:3e3})}}))):n({title:"获取数据失败，请重试",icon:"none"})}}))},prepareWechatAuth(){return _(this,void 0,void 0,(function*(){try{localStorage.removeItem("token"),localStorage.removeItem("wechat_user_info");const e=window.location.origin+window.location.pathname;if(window.location.search.includes("code="))return window.location.replace(e),Promise.resolve(null);const o=T();if(o)return console.log("发现已存储的用户信息，直接使用"),this.userInfo=o,this.loading=!1,this.getUserListFn(),Promise.resolve(null);console.log("准备跳转到微信授权页"),this.loadingText="正在跳转到微信授权...",this.loadingSubtext="请稍候，即将跳转到微信授权页面",yield new Promise(e=>setTimeout(e,500)),yield b()}catch(e){console.error("准备微信授权失败:",e),this.loading=!1}}))},initializeAuth(){return _(this,void 0,void 0,(function*(){try{const e=T();if(e)return console.log("发现已存储的用户信息"),this.userInfo=e,this.loading=!1,this.getUserListFn(),Promise.resolve(null);console.log("开始微信授权流程"),this.loadingText="正在处理微信授权...",this.loadingSubtext="请稍候，正在验证您的身份";const o=yield b();console.log("微信授权完成:",o),o&&(this.userInfo=o),this.loading=!1,this.getUserListFn()}catch(e){n({title:"授权失败，请重试",icon:"none"}),console.error("授权失败:",e),this.loading=!1}}))},viewHistory(){if(this.isNavigating||this.loading)return console.log("正在跳转中或页面还在加载，忽略点击"),null;const e=localStorage.getItem("token");if(!e)return console.log("没有token，需要先授权"),o(new UTSJSONObject({title:"需要授权",content:"请先完成微信授权后再查看历史记录",confirmText:"立即授权",cancelText:"取消",success:e=>{e.confirm&&this.prepareWechatAuth()}})),null;this.isNavigating=!0,console.log("开始跳转到历史记录页面"),console.log("当前用户信息:",this.userInfo),console.log("当前token:",e),t({url:"/pages/patient/history",success:()=>{console.log("跳转成功")},fail:e=>{console.error("跳转失败:",e),this.isNavigating=!1,n({title:"跳转失败，请重试",icon:"none"})},complete:()=>{setTimeout(()=>{this.isNavigating=!1},1e3)}})},handleGetUserinfo(){(e=>{v("/user/wechat-login/?code=".concat(e))})(I().code)},fetchReportList(){return _(this,void 0,void 0,(function*(){try{const e=yield getReportList();e.results&&200===e.results.code&&(this.reportList=e.results.data)}catch(e){n({title:"获取报告失败",icon:"none"})}}))},viewReport(e=null){window.open("http://277fbfd6.cpolar.top/report/wechat-export/?report_id=".concat(e.report_id))}}}),[["render",function(e,o,t,n,_,v){const x=a,y=w,S=m;return s(),i(x,null,{default:l(()=>[_.loading?(s(),i(x,{key:0,class:"loading-overlay"},{default:l(()=>[c(x,{class:"loading-content"},{default:l(()=>[c(x,{class:"loading-spinner"}),c(y,{class:"loading-text"},{default:l(()=>[r(d(_.loadingText),1)]),_:1}),_.loadingSubtext?(s(),i(y,{key:0,class:"loading-subtext"},{default:l(()=>[r(d(_.loadingSubtext),1)]),_:1})):u("",!0)]),_:1})]),_:1})):u("",!0),_.loading?u("",!0):(s(),i(x,{key:1},{default:l(()=>[c(x,{class:"actions"},{default:l(()=>[c(S,{onClick:v.viewHistory,disabled:_.loading},{default:l(()=>[r("查看历史检测记录")]),_:1},8,["onClick","disabled"])]),_:1}),g("div",{id:"ai-chat"}),_.reportList.length?(s(),i(x,{key:0},{default:l(()=>[(s(!0),h(p,null,f(_.reportList,e=>(s(),i(x,{key:e.report_id,class:"report-card"},{default:l(()=>[c(x,null,{default:l(()=>[r(d(e.name),1)]),_:2},1024),c(x,null,{default:l(()=>[r("机构："+d(e.company),1)]),_:2},1024),c(x,null,{default:l(()=>[r(d(e.time),1)]),_:2},1024),c(S,{onClick:o=>v.viewReport(e)},{default:l(()=>[r("查看报告")]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})):u("",!0)]),_:1}))]),_:1})}],["__scopeId","data-v-80e9202a"]]);export{L as default};
